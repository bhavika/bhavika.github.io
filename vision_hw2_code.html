<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title> Bhavika Tekwani </title>
  <meta name="description" content="Personal website, portfolio, bio">
  <meta name="author" content="Bhavika Tekwani">

  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font Awesome Social Icons -->
  <link rel="stylesheet" href="./font-awesome-4.7.0/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <link rel="stylesheet" href="css/bhavikatekwani.css">

</head>

<body>
    <h5> Assignment 2 </h5>
    <h6> There are two program files - part1.py and part2.py, both displayed below. </h6>
    <h5> part1.py </h5>

    <pre class="prettyprint">
              import cv2
              from matplotlib import pyplot as plt
              from Tkinter import *
              import os


              def histogram(image):
              color = ('b', 'g', 'r')
              for i, col in enumerate(color):
                  histr = cv2.calcHist([image], [i], None, [256], [0, 256])
                  plt.plot(histr, color=col)
                  plt.xlim([0, 256])
              plt.show()


              def callback():
              fname = e.get()

              def mouse_callback(event, x, y, flags, params):
                  # left-click event value is 1
                  # if event == 1
                  if event == cv2.EVENT_LBUTTONDBLCLK:
                      color = img[x, y]
                      print("Location", x, y)
                      print("Red: {}, Green: {}, Blue: {}".format(color[2], color[1], color[0]))
                      print('Intensity:', color[0] + color[1] + color[2] / 3)
                      x = cv2.rectangle(img, (x+11, y), (x, y+11), (34, 200, 100), thickness=1)
                      mean, std_dev = cv2.meanStdDev(x)
                      print("Mean {}, standard deviation: {}".format(mean, std_dev))

              if os.path.exists(fname):
                  img = cv2.imread(fname)
                  print(fname)
                  while True:
                      cv2.imshow('image', img)
                      cv2.setMouseCallback('image', mouse_callback)
                      if cv2.waitKey(20) & 0xFF == 27:
                          break
                  cv2.destroyAllWindows()


              if __name__ == '__main__':

              box = Tk()
              box.title("File selector")
              label = Label(box, text='Filepath')
              fname = StringVar()
              e = Entry(box, textvariable=fname)

              label.pack(side=LEFT)
              e.pack(side=RIGHT)

              btn = Button(box, text='Submit', command=callback)
              btn.pack(side=BOTTOM)
              box.mainloop()
    </pre>

    <h5> part2.py </h5>

    <pre class="prettyprint">
      import cv2
      import os
      from scipy import misc
      from time import time
      import itertools
      from collections import defaultdict
      import numpy as np
      import pandas as pd


      def create_histogram(img):
          import matplotlib.pyplot as plt

          histr = cv2.calcHist([img], [0], None, [512], [0, 512])
          plt.plot(histr)
          plt.xlim([0, 512])
          plt.show()


      def create_index(dir, img):
          path = os.path.join(dir, img)

          img_array = misc.imread(path)
          imgc = img_array.copy()

          b, g, r = cv2.split(imgc)
          b = b.astype(np.uint16)
          g = g.astype(np.uint16)
          r = r.astype(np.uint16)

          b = np.apply_along_axis(lambda x: x >> 5, 0, b)
          g = np.apply_along_axis(lambda x: (x >> 5) << 3, 0, g)
          r = np.apply_along_axis(lambda x: (x >> 5) << 6, 0, r)

          img_new = np.concatenate((b, g, r), axis=0)

          img_new = img_new.reshape(-1)
          h = np.histogram(img_new, bins=512, range=[0, 511])

          return h


      def hist_intersection(histograms):
          combinations = list(map(dict, itertools.combinations(histograms.items(), 2)))
          intersections = defaultdict(dict)

          for c in combinations:
              k = c.keys()
              x = c[k[0]][0]
              y = c[k[1]][0]

              mins = np.minimum(x, y)
              maxs = np.maximum(x, y)

              intersections[k[0]][k[1]] = float(np.sum(mins))/np.sum(maxs)

          for k, v in intersections.items():
              intersections[k][k] = 1.0

          return intersections


      def chisq_measure(histograms):
          combinations = list(map(dict, itertools.combinations(histograms.items(), 2)))

          chsq = defaultdict(dict)

          for c in combinations:
              k = c.keys()
              x = c[k[0]][0]
              y = c[k[1]][0]

              diff = np.subtract(x, y)
              denom = np.add(x, y)
              diff = np.apply_along_axis(lambda x: x ** 2, 0, diff)

              diff = diff[denom != 0]
              denom = denom[denom != 0]

              divs = np.divide(diff, denom)

              chsq[k[0]][k[1]] = np.sum(divs)

          for k, v in chsq.items():
              chsq[k][k] = 0

          return chsq


      def visualize(df, title, ticks):
          import matplotlib.pyplot as plt
          from matplotlib import cm as cm

          fig = plt.figure()
          ax1 = fig.add_subplot(111)
          cmap = cm.get_cmap('gray', 30)
          cax = ax1.imshow(df, interpolation=None, cmap=cmap)
          ax1.grid(True)
          plt.title(title)
          labels = [x for x in range(6)]
          ax1.set_xticklabels(labels, fontsize=11)
          ax1.set_yticklabels(labels, fontsize=11)
          # Add colorbar, make sure to specify tick locations to match desired ticklabels
          fig.colorbar(cax, ticks=ticks)
          plt.show()


      def adjust_dictionaries(ddict):
          for k, v in ddict.items():
              for i, j in v.items():
                  ddict[i][k] = j

          return ddict

      if __name__ == '__main__':
          dir = './images/ST2MainHall4'
          images = os.listdir(dir)

          hists = {}

          start_time = time()

          for i in images:
              fname = i[-8:-4]
              h = create_index(dir, i)
              hists[fname] = h

          print "Time (in seconds) to create color histograms for all images: ", time() - start_time

          intersections = hist_intersection(hists)
          chsq = chisq_measure(hists)

          i_dict = adjust_dictionaries(intersections)
          chsq_dict = adjust_dictionaries(chsq)

          i = pd.DataFrame.from_dict(i_dict, orient='columns')
          c = pd.DataFrame.from_dict(chsq_dict, orient='columns')

          i_max = i.max().max()
          c_max = c.max().max()

          i_ticks = np.linspace(0, i_max, 6)[1:]
          c_ticks = np.linspace(0, c_max, 6)[1:]

          visualize(i, title='Intersection', ticks=i_ticks)
          visualize(c, title='Chi-square measure', ticks=c_ticks)
    </pre>


</body>
